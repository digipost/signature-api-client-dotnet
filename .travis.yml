sudo: required
language: csharp
solution: api-client-shared.sln
mono: none
git:
  submodules: false
dotnet: 2.1.403
before_install:
  # Change github url to https for submodules
  - sed -i 's/git@github.com:/https:\/\/github.com\//' .gitmodules
  - git submodule update --init --recursive

  # Decrypt private key used for tests
  - openssl aes-256-cbc -K $encrypted_3afad0b3f334_key -iv $encrypted_3afad0b3f334_iv
    -in Bring_Digital_Signature_Key_Encipherment_Data_Encipherment.p12.enc -out Digipost.Signature.Api.Client.Core/Bring_Digital_Signature_Key_Encipherment_Data_Encipherment.p12
    -d

  - ./travis-deploy/patch-assembly-version.sh Directory.Build.props beta ${TRAVIS_BUILD_NUMBER} #Todo: TRAVIS_BRANCH til beta for å forenkle utvikling. FIks!

install:
  - dotnet restore
    
script:
  - set -e #Makes sure we get a fail fast if some of the scripts fails
  - dotnet build -c Release
  - ./travis-deploy/add-secrets.sh
  - dotnet test Digipost.Signature.Api.Client.Direct.Tests/Digipost.Signature.Api.Client.Direct.Tests.csproj
  - dotnet test Digipost.Signature.Api.Client.Core.Tests/Digipost.Signature.Api.Client.Core.Tests.csproj
  - dotnet test Digipost.Signature.Api.Client.Portal.Tests/Digipost.Signature.Api.Client.Portal.Tests.csproj
  - PROJECT_DIRECTORIES="Digipost.Signature.Api.Client.Core Digipost.Signature.Api.Client.Direct Digipost.Signature.Api.Client.Portal Digipost.Signature.Api.Client.Resources Digipost.Signature.Api.Client.Scripts" && ./travis-deploy/pack-and-push.sh beta $NUGET_API_KEY $TRAVIS_BUILD_DIR "${PROJECT_DIRECTORIES}" #Todo: satt til beta for å forenkle utvikling. FIks!

